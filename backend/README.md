# Backend (Cloudflare Workers + Hono)

åŸºäº Cloudflare Workers ä¸ Hono æ„å»ºçš„åç«¯æœåŠ¡å±‚ï¼Œç›®æ ‡ï¼šè½»é‡ã€å¯æ‰©å±•ã€ä½è¿ç»´æˆæœ¬ï¼Œä¸ºå‰ç«¯ SvelteKit æä¾› APIï¼ˆåç»­è®¡åˆ’ GraphQL / REST ç»Ÿä¸€æŠ½è±¡ï¼‰ã€‚

---

## âœ¨ åŠŸèƒ½å®šä½ï¼ˆå½“å‰é˜¶æ®µï¼‰

- å¥åº·æ£€æŸ¥ä¸åŸºç¡€è·¯ç”±ï¼ˆ/health è®¡åˆ’ä¸­ï¼‰
- ä»»åŠ¡ / æ ‡ç­¾ç­‰æ ¸å¿ƒå®ä½“çš„æœ€å° CRUDï¼ˆè§„åˆ’ä¸­ï¼‰
- è¾“å…¥/è¾“å‡º Schema æ ¡éªŒï¼ˆZodï¼‰
- ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼ˆå¾…æ·»åŠ ä¸­é—´ä»¶ï¼‰
- æ•°æ®å­˜å‚¨ï¼šD1ï¼ˆç»“æ„åŒ–ï¼‰+ KVï¼ˆç¼“å­˜ / Session è§„åˆ’ï¼‰+ R2ï¼ˆé™„ä»¶è§„åˆ’ï¼‰

---

## ğŸ§© æŠ€æœ¯æ ˆ

| é¢†åŸŸ         | é€‰å‹               | è¯´æ˜                       |
| ------------ | ------------------ | -------------------------- |
| è¿è¡Œæ—¶       | Cloudflare Workers | è¾¹ç¼˜è®¡ç®— & å…¨çƒåŠ é€Ÿ        |
| Web æ¡†æ¶     | Hono ^4            | è½»é‡ã€å¿«é€Ÿã€è‰¯å¥½ä¸­é—´ä»¶ç”Ÿæ€ |
| æ ¡éªŒ         | Zod ^3             | è¯·æ±‚/å“åº” Schema ç®¡ç†      |
| æ–‡æ¡£ï¼ˆå¯é€‰ï¼‰ | chanfana           | OpenAPI ç”Ÿæˆï¼ˆåç»­å¯æ¥å…¥ï¼‰ |
| æ„å»º / æœ¬åœ°  | Wrangler ^4        | Dev / éƒ¨ç½² / èµ„æºç»‘å®š      |
| è¯­è¨€         | TypeScript         | å¼ºç±»å‹ä¸çº¦æŸ               |

---

## ğŸ“ ç›®å½•ç»“æ„

```
backend/
  src/
    index.ts           # å…¥å£ï¼ˆåˆ›å»º Hono åº”ç”¨ã€æ³¨å†Œè·¯ç”±/ä¸­é—´ä»¶ï¼‰
    routes/            # è·¯ç”±æ¨¡å—ï¼ˆæŒ‰èµ„æºæ‹†åˆ†ï¼‰
    middlewares/       # æ—¥å¿— / é”™è¯¯ / é‰´æƒç­‰ï¼ˆå¾…å®ç°ï¼‰
    services/          # ä¸šåŠ¡é€»è¾‘èšåˆå±‚ï¼ˆè°ƒç”¨ storage + ç»„åˆè¿”å›ï¼‰
    storage/           # æ•°æ®è®¿é—®å°è£…ï¼ˆD1/KV/R2 ç­‰ï¼‰
    utils/             # é€šç”¨å·¥å…·
  migrations/          # D1 SQL è¿ç§» (e.g. 0001_init.sql)
  wrangler.toml        # Workers + èµ„æºç»‘å®šé…ç½®
  worker-configuration.d.ts # ç¯å¢ƒç±»å‹è¡¥å……
```

---

## ğŸ”§ NPM è„šæœ¬

| è„šæœ¬                 | ä½œç”¨                                        |
| -------------------- | ------------------------------------------- |
| `npm run dev`        | æœ¬åœ°å¼€å‘ï¼ˆwrangler devï¼‰                    |
| `npm start`          | ç­‰åŒ dev                                    |
| `npm run deploy`     | éƒ¨ç½²åˆ°ç”Ÿäº§ / æŒ‡å®šç¯å¢ƒ                       |
| `npm run cf-typegen` | åŸºäº wrangler ç”Ÿæˆç¯å¢ƒç±»å‹ï¼ˆbindings d.tsï¼‰ |

PowerShell å¿«é€Ÿå¯åŠ¨ï¼š

```pwsh
cd backend
npm install
npm run dev
```

---

## âš™ï¸ Wrangler / èµ„æºç»‘å®šç¤ºä¾‹

`wrangler.toml`ï¼ˆç¤ºæ„ï¼ŒæŒ‰å®é™…è¡¥å……ï¼‰ï¼š

```toml
name = "routine-backend"
main = "src/index.ts"
compatibility_date = "2025-09-01"

[d1_databases]
[[d1_databases]]
binding = "DB"
database_name = "routine-db"
database_id = "<your-d1-id>"

[kv_namespaces]
# [[kv_namespaces]]
# binding = "KV"
# id = "<kv-id>"
```

å¼€å‘é¦–æ¬¡åˆ›å»ºæœ¬åœ° D1:

```pwsh
wrangler d1 migrations apply routine-db --local
```

è¿è¡Œè¿ç§»ï¼ˆè¿œç«¯ï¼‰ï¼š

```pwsh
wrangler d1 migrations apply routine-db
```

---

## ğŸ—„ï¸ æ•°æ®è¿ç§»

- æ–°å¢è¡¨ç»“æ„ï¼šåœ¨ `migrations/` ä¸‹æ–°å¢ `0002_xxx.sql`
- å‘½åè§„èŒƒï¼šæŒ‰é€’å¢åºå· + ä¸‹åˆ’çº¿è¯´æ˜
- ç¦æ­¢ç›´æ¥åœ¨ç”Ÿäº§æ‰‹åŠ¨æ”¹è¡¨ï¼Œå¿…é¡»é€šè¿‡è¿ç§»

---

## ğŸ§ª æµ‹è¯•ï¼ˆè§„åˆ’ï¼‰

| ç±»å‹     | è¯´æ˜               | çŠ¶æ€   |
| -------- | ------------------ | ------ |
| å•å…ƒæµ‹è¯• | storage / services | å¾…æ·»åŠ  |
| è·¯ç”±æµ‹è¯• | Hono fetch æµ‹è¯•    | å¾…æ·»åŠ  |
| é›†æˆæµ‹è¯• | ç»“åˆ D1 (local)    | è§„åˆ’   |

å»ºè®®ä½¿ç”¨ Vitest + Miniflareï¼ˆæˆ– Wrangler æœ¬åœ°æ¨¡æ‹Ÿï¼‰

---

## ğŸ›¡ï¸ é”™è¯¯ä¸ä¸­é—´ä»¶ï¼ˆè§„åˆ’ï¼‰

è®¡åˆ’ä¸­é—´ä»¶ï¼š

1. æ—¥å¿—ï¼šè¯·æ±‚è€—æ—¶ã€çŠ¶æ€ç 
2. ç»Ÿä¸€é”™è¯¯å“åº”ç»“æ„ `{ code, message, details? }`
3. CORSï¼ˆç”Ÿäº§é™åˆ¶åŸŸåï¼‰
4. é‰´æƒï¼ˆåç»­æ·»åŠ  Token / Sessionï¼‰

---

## ğŸš€ éƒ¨ç½²æµç¨‹ï¼ˆå»ºè®® CIï¼‰

1. `npm ci`
2. ï¼ˆå¯é€‰ï¼‰è¿è¡Œæµ‹è¯•
3. `npm run deploy`

GitHub Actions éœ€é…ç½®ï¼š

- `CLOUDFLARE_API_TOKEN`
- `CLOUDFLARE_ACCOUNT_ID`

---

## ğŸ” ç¯å¢ƒå˜é‡ / Bindings

é€šè¿‡ Wrangler èµ„æºç»‘å®šè€Œé `.env`ã€‚å¦‚éœ€é€»è¾‘æ¡ä»¶ï¼š

```ts
export type Env = {
	DB: D1Database;
	// KV: KVNamespace; // è§„åˆ’
};
```

---

## ğŸ“‘ API çº¦å®šï¼ˆè‰æ¡ˆï¼‰

- JSON å“åº”ç»Ÿä¸€ï¼š

```jsonc
{ "data": <T> , "error": null }
{ "data": null , "error": { "code": "BadRequest", "message": "..." } }
```

- å…¥å‚å…¨éƒ¨ Zod æ ¡éªŒï¼›å¤±è´¥è¿”å› 400 + é”™è¯¯æšä¸¾

---

## ğŸ§± ä»£ç é£æ ¼

- ESM + TS
- å‡½æ•°çº¯åº¦ä¼˜å…ˆï¼Œå‰¯ä½œç”¨é›†ä¸­åœ¨ service / storage
- è·¯ç”±æ–‡ä»¶åªåšï¼šè§£æè¾“å…¥ -> è°ƒ service -> è¿”å›

---

## ğŸ§© åç»­è·¯çº¿

- [ ] å¥åº·æ£€æŸ¥ `/health`
- [ ] é”™è¯¯å¤„ç†ä¸­é—´ä»¶
- [ ] ä»»åŠ¡ CRUD åŸºç¡€ Schema + è·¯ç”±
- [ ] é‰´æƒå ä½ï¼ˆåŒ¿å / guest æ”¯æŒï¼‰
- [ ] OpenAPI ç”Ÿæˆ & æ–‡æ¡£æ‰˜ç®¡
